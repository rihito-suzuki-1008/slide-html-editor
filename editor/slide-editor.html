<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>„Çπ„É©„Ç§„ÉâÁ∑®ÈõÜ„Ç∑„Çπ„ÉÜ„É†</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Helvetica Neue', Arial, 'Hiragino Sans', 'Hiragino Kaku Gothic ProN', sans-serif;
            background: #f5f5f5;
            display: flex;
            height: 100vh;
        }
        
        /* „Çµ„Ç§„Éâ„Éê„Éº */
        .sidebar {
            width: 250px;
            background: #1e3a5f;
            color: white;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }
        
        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid #2a4a6f;
        }
        
        .sidebar h2 {
            font-size: 18px;
            margin-bottom: 15px;
        }
        
        .new-slide-btn {
            background: #4caf50;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            width: 100%;
            transition: background 0.2s;
        }
        
        .new-slide-btn:hover {
            background: #5cbf60;
        }
        
        .slide-list {
            list-style: none;
            flex: 1;
        }
        
        .slide-item {
            padding: 15px 20px;
            cursor: pointer;
            transition: background 0.2s;
            border-bottom: 1px solid #2a4a6f;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .slide-item:hover {
            background: #2a4a6f;
        }
        
        .slide-item.active {
            background: #4a7ba7;
        }
        
        .slide-item.modified::after {
            content: '‚óè';
            color: #ff9800;
            margin-left: 5px;
        }
        
        .slide-item .slide-actions {
            display: flex;
            gap: 5px;
        }
        
        .slide-action-btn {
            background: none;
            border: none;
            color: #ccc;
            cursor: pointer;
            font-size: 12px;
            padding: 2px 5px;
            border-radius: 3px;
            transition: all 0.2s;
        }
        
        .slide-action-btn:hover {
            background: rgba(255,255,255,0.1);
            color: white;
        }
        
        /* „É°„Ç§„É≥„Ç®„É™„Ç¢ */
        .main-area {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        /* „ÉÑ„Éº„É´„Éê„Éº */
        .toolbar {
            background: white;
            padding: 15px 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .toolbar button {
            padding: 8px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }
        
        .save-btn {
            background: #4caf50;
            color: white;
        }
        
        .save-btn:hover {
            background: #5cbf60;
        }
        
        .save-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .reload-btn {
            background: #2196f3;
            color: white;
        }
        
        .reload-btn:hover {
            background: #31a6ff;
        }
        
        .preview-btn {
            background: #673ab7;
            color: white;
        }
        
        .preview-btn:hover {
            background: #7e4cc9;
        }
        
        .edit-mode-toggle {
            background: #ff9800;
            color: white;
            margin-left: auto;
        }
        
        .edit-mode-toggle:hover {
            background: #ffab00;
        }
        
        .edit-mode-toggle.active {
            background: #f44336;
        }
        
        .layout-mode-toggle {
            background: #9c27b0;
            color: white;
            margin-left: 10px;
        }
        
        .layout-mode-toggle:hover {
            background: #af2cc5;
        }
        
        .layout-mode-toggle.active {
            background: #e91e63;
        }
        
        .html-editor-toggle {
            background: #607d8b;
            color: white;
            margin-left: 10px;
            display: none;
        }
        
        .html-editor-toggle:hover {
            background: #78909c;
        }
        
        .html-editor-toggle.active {
            background: #455a64;
        }
        
        /* „Ç≥„É≥„ÉÜ„É≥„ÉÑ„Ç®„É™„Ç¢ */
        .content-area {
            flex: 1;
            display: flex;
            gap: 20px;
            padding: 20px;
            overflow: hidden;
        }
        
        /* „Éó„É¨„Éì„É•„Éº„Ç®„É™„Ç¢ */
        .preview-container {
            flex: 1;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            position: relative;
        }
        
        .preview-header {
            padding: 15px 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #e0e0e0;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        /* „Éó„É¨„Éì„É•„Éº„Çø„Éñ„ÅÆË°®Á§∫Âà∂Âæ° */
        .preview-tabs {
            display: flex;
            gap: 10px;
            transition: opacity 0.3s;
        }
        
        .preview-tabs.hidden {
            display: none;
        }
        
        .preview-tab {
            padding: 8px 16px;
            background: #e9ecef;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
        }
        
        .preview-tab.active {
            background: #007bff;
            color: white;
        }
        
        .preview-tab:hover:not(.active) {
            background: #dee2e6;
        }
        
        .preview-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
        }
        
        .preview-frame {
            flex: 1;
            width: 100%;
            border: none;
            display: block;
        }
        
        .html-editor-container {
            flex: 1;
            display: none;
            flex-direction: column;
        }
        
        .html-editor-container.active {
            display: flex;
        }
        
        .html-editor-toolbar {
            padding: 10px;
            background: #f8f9fa;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .html-editor-toolbar button {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
        }
        
        .format-btn {
            background: #6c757d;
            color: white;
        }
        
        .format-btn:hover {
            background: #5a6268;
        }
        
        .apply-btn {
            background: #28a745;
            color: white;
        }
        
        .apply-btn:hover {
            background: #218838;
        }
        
        .html-editor {
            flex: 1;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.5;
            border: none;
            padding: 15px;
            resize: none;
            background: #f8f9fa;
            color: #333;
            white-space: pre;
            overflow-wrap: normal;
            overflow-x: auto;
        }
        
        .html-editor:focus {
            outline: none;
            background: white;
        }
        
        .layout-overlay {
            position: absolute;
            top: 0px; 
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: auto;
            z-index: 100;
            display: none;
            overflow: hidden;
        }
        
        .layout-mode .layout-overlay {
            display: block;
        }
        
        /* Á∑®ÈõÜ„Éë„Éç„É´ */
        .edit-panel {
            width: 400px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: none;
            flex-direction: column;
        }
        
        .edit-panel.show {
            display: flex;
        }
        
        .edit-panel-header {
            padding: 15px 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #e0e0e0;
            font-weight: bold;
        }
        
        .edit-panel-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }
        
        .edit-field {
            margin-bottom: 20px;
        }
        
        .edit-field label {
            display: block;
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .edit-field textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            resize: vertical;
            min-height: 60px;
        }
        
        .edit-field textarea:focus {
            outline: none;
            border-color: #4a7ba7;
        }
        
        /* ÈÅ∏ÊäûÂèØËÉΩ„Å™Ë¶ÅÁ¥†„ÅÆ„Ç™„Éº„Éê„Éº„É¨„Ç§ */
        .element-overlay {
            position: absolute;
            border: 2px dashed transparent;
            background: transparent;
            cursor: pointer;
            pointer-events: auto;
            transition: all 0.2s;
        }
        
        .element-overlay:hover {
            border-color: #2196f3;
            background: rgba(33, 150, 243, 0.1);
        }
        
        .element-overlay.selected {
            border-color: #f44336;
            background: rgba(244, 67, 54, 0.1);
            border-style: solid;
        }
        
        .element-overlay.dragging {
            opacity: 0.7;
        }
        
        /* „É™„Çµ„Ç§„Ç∫„Éè„É≥„Éâ„É´ */
        .resize-handle {
            position: absolute;
            width: 10px;
            height: 10px;
            background: #fff;
            border: 2px solid #f44336;
            border-radius: 50%;
            display: none;
        }
        
        .element-overlay.selected .resize-handle {
            display: block;
        }
        
        .resize-handle.nw { top: -5px; left: -5px; cursor: nw-resize; }
        .resize-handle.ne { top: -5px; right: -5px; cursor: ne-resize; }
        .resize-handle.sw { bottom: -5px; left: -5px; cursor: sw-resize; }
        .resize-handle.se { bottom: -5px; right: -5px; cursor: se-resize; }
        
        /* Â∫ßÊ®ôË°®Á§∫ */
        .position-info {
            position: absolute;
            top: -25px;
            left: 0;
            background: #333;
            color: white;
            padding: 2px 8px;
            font-size: 11px;
            border-radius: 3px;
            white-space: nowrap;
            pointer-events: auto;
            display: none;
        }
        
        .element-overlay.selected .position-info {
            display: block;
        }
        
        /* „Ç∞„É™„ÉÉ„ÉâË°®Á§∫ */
        .preview-container.show-grid .layout-overlay::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: 
                repeating-linear-gradient(0deg, transparent, transparent 9px, rgba(0,0,0,0.05) 9px, rgba(0,0,0,0.05) 10px),
                repeating-linear-gradient(90deg, transparent, transparent 9px, rgba(0,0,0,0.05) 9px, rgba(0,0,0,0.05) 10px);
            pointer-events: auto;
            z-index: -1;
        }
        
        /* „Çπ„ÉÜ„Éº„Çø„Çπ„Éê„Éº */
        .status-bar {
            background: #333;
            color: white;
            padding: 10px 20px;
            font-size: 12px;
            display: flex;
            justify-content: space-between;
        }
        
        /* „É≠„Éº„Éá„Ç£„É≥„Ç∞ */
        .loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 20px 40px;
            border-radius: 8px;
            display: none;
            z-index: 1000;
        }
        
        .loading.show {
            display: block;
        }
        
        .toast {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: #333;
            color: white;
            padding: 15px 25px;
            border-radius: 5px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.3s;
            z-index: 1000;
        }
        
        .toast.show {
            opacity: 1;
            transform: translateY(0);
        }
        
        .toast.success {
            background: #4caf50;
        }
        
        .toast.error {
            background: #f44336;
        }
        
        /* Êñ∞Ë¶è„Çπ„É©„Ç§„Éâ„É¢„Éº„ÉÄ„É´ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            animation: fadeIn 0.3s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .modal-content {
            background: white;
            max-width: 600px;
            margin: 100px auto;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            animation: slideIn 0.3s;
        }
        
        @keyframes slideIn {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        .modal-header {
            font-size: 24px;
            margin-bottom: 20px;
            color: #1e3a5f;
        }
        
        .template-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .template-card {
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            background: white;
        }
        
        .template-card:hover {
            border-color: #4a7ba7;
            background: #f8f9fa;
        }
        
        .template-card.selected {
            border-color: #4a7ba7;
            background: #e3f2fd;
        }
        
        .template-card .template-icon {
            font-size: 32px;
            margin-bottom: 10px;
        }
        
        .template-card .template-name {
            font-size: 14px;
            font-weight: bold;
            color: #333;
        }
        
        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 15px;
            margin-top: 30px;
        }
        
        .modal-footer button {
            padding: 10px 25px;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .cancel-btn {
            background: #f5f5f5;
            color: #666;
        }
        
        .cancel-btn:hover {
            background: #e0e0e0;
        }
        
        .create-btn {
            background: #4caf50;
            color: white;
        }
        
        .create-btn:hover {
            background: #5cbf60;
        }
        
        .html-paste-area {
            margin-bottom: 20px;
        }
        
        .html-paste-area label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #555;
        }
        
        .html-paste-area textarea {
            width: 100%;
            height: 200px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            resize: vertical;
        }
        
        .html-paste-area textarea:focus {
            outline: none;
            border-color: #4a7ba7;
        }
    </style>
</head>
<body>
    <div class="sidebar">
        <div class="sidebar-header">
            <h2>üìë „Çπ„É©„Ç§„Éâ‰∏ÄË¶ß</h2>
            <button class="new-slide-btn" onclick="showNewSlideModal()">
                ‚ûï Êñ∞Ë¶è„Çπ„É©„Ç§„Éâ
            </button>
        </div>
        <ul class="slide-list" id="slideList">
            <!-- „Çπ„É©„Ç§„Éâ‰∏ÄË¶ß„Åå„Åì„Åì„Å´Ë°®Á§∫„Åï„Çå„Çã -->
        </ul>
    </div>
    
    <div class="main-area">
        <div class="toolbar">
            <button class="save-btn" id="saveBtn" onclick="saveCurrentSlide()" disabled>
                üíæ ‰øùÂ≠ò (Ctrl+S)
            </button>
            <button class="reload-btn" onclick="reloadCurrentSlide()">
                üîÑ ÂÜçË™≠„ÅøËæº„Åø
            </button>
            <button class="preview-btn" onclick="openPreview()">
                üëÅÔ∏è ÂÖ®‰Ωì„Éó„É¨„Éì„É•„Éº
            </button>
            <span id="currentSlideInfo">„Çπ„É©„Ç§„Éâ„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</span>
            <button class="edit-mode-toggle" id="editModeBtn" onclick="toggleEditMode()">
                ‚úèÔ∏è Á∞°ÊòìÁ∑®ÈõÜ„É¢„Éº„Éâ
            </button>
            <button class="layout-mode-toggle" id="layoutModeBtn" onclick="toggleLayoutMode()">
                üé® „É¨„Ç§„Ç¢„Ç¶„ÉàÁ∑®ÈõÜ
            </button>

        </div>
        
        <div class="content-area">
            <div class="preview-container" id="previewContainer">
                <div class="preview-header">
                    <span>„Éó„É¨„Éì„É•„Éº</span>
                    <div class="preview-tabs">
                        <button class="preview-tab active" onclick="switchPreviewTab('preview')">„Éó„É¨„Éì„É•„Éº</button>
                        <button class="preview-tab" onclick="switchPreviewTab('html')">HTML</button>
                    </div>
                </div>
                <div class="preview-content">
                    <iframe class="preview-frame" id="previewFrame"></iframe>
                    <div class="html-editor-container" id="htmlEditorContainer">
                        <div class="html-editor-toolbar">
                            <button class="format-btn" onclick="formatHtml()">üé® „Éï„Ç©„Éº„Éû„ÉÉ„Éà</button>
                            <span style="margin-left: auto; font-size: 12px; color: #666;">
                                Ctrl+S „Åß‰øùÂ≠ò
                            </span>
                        </div>
                        <textarea class="html-editor" id="htmlEditor" placeholder="HTML„Ç≥„Éº„Éâ„ÇíÂÖ•Âäõ„Åæ„Åü„ÅØ„Éö„Éº„Çπ„Éà„Åó„Å¶„Åè„Å†„Åï„ÅÑ..."></textarea>
                    </div>
                </div>
                <div class="layout-overlay" id="layoutOverlay"></div>
            </div>
            
            <div class="edit-panel" id="editPanel">
                <div class="edit-panel-header">
                    „ÉÜ„Ç≠„Çπ„ÉàÁ∑®ÈõÜ
                </div>
                <div class="edit-panel-content" id="editPanelContent">
                    <!-- Á∑®ÈõÜ„Éï„Ç£„Éº„É´„Éâ„Åå„Åì„Åì„Å´Ë°®Á§∫„Åï„Çå„Çã -->
                </div>
            </div>
        </div>
        
        <div class="status-bar">
            <span id="statusText">Ê∫ñÂÇôÂÆå‰∫Ü</span>
            <span id="serverStatus">„Çµ„Éº„Éê„Éº: Êé•Á∂ö‰∏≠...</span>
        </div>
    </div>
    
    <!-- Êñ∞Ë¶è„Çπ„É©„Ç§„Éâ„É¢„Éº„ÉÄ„É´ -->
    <div id="newSlideModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">Êñ∞Ë¶è„Çπ„É©„Ç§„Éâ„ÅÆ‰ΩúÊàê</div>
            
            <div class="template-grid">
                <div class="template-card" data-template="blank">
                    <div class="template-icon">üìÑ</div>
                    <div class="template-name">Á©∫„ÅÆ„Çπ„É©„Ç§„Éâ</div>
                </div>
                <div class="template-card" data-template="title">
                    <div class="template-icon">üìù</div>
                    <div class="template-name">„Çø„Ç§„Éà„É´„Çπ„É©„Ç§„Éâ</div>
                </div>
                <div class="template-card" data-template="content">
                    <div class="template-icon">üìã</div>
                    <div class="template-name">„Ç≥„É≥„ÉÜ„É≥„ÉÑ„Çπ„É©„Ç§„Éâ</div>
                </div>
                <div class="template-card" data-template="summary">
                    <div class="template-icon">üìä</div>
                    <div class="template-name">„Åæ„Å®„ÇÅ„Çπ„É©„Ç§„Éâ</div>
                </div>
                <div class="template-card selected" data-template="html">
                    <div class="template-icon">üóÇÔ∏è</div>
                    <div class="template-name">HTML„Éö„Éº„Çπ„Éà</div>
                </div>
            </div>
            
            <div class="html-paste-area" id="htmlPasteArea">
                <label for="htmlPaste">HTML„Ç≥„Éº„Éâ„Çí„Éö„Éº„Çπ„Éà:</label>
                <textarea id="htmlPaste" placeholder="AI„ÅßÁîüÊàê„Åï„Çå„ÅüHTML„Ç≥„Éº„Éâ„Çí„Åì„Åì„Å´„Éö„Éº„Çπ„Éà„Åó„Å¶„Åè„Å†„Åï„ÅÑ..."></textarea>
            </div>
            
            <div class="modal-footer">
                <button class="cancel-btn" onclick="hideNewSlideModal()">„Ç≠„É£„É≥„Çª„É´</button>
                <button class="create-btn" onclick="createNewSlide()">‰ΩúÊàê</button>
            </div>
        </div>
    </div>
    
    <div class="loading" id="loading">Ë™≠„ÅøËæº„Åø‰∏≠...</div>
    <div class="toast" id="toast"></div>
    
    <script>
        const API_URL = 'http://localhost:3000/api';
        let currentSlide = null;
        let originalContent = null;
        let isModified = false;
        let editMode = false;
        let layoutMode = false;
        let htmlEditorMode = false;
        let textElements = [];
        let currentProjectName = null;
        let selectedTemplate = 'html';
        
        // „É¨„Ç§„Ç¢„Ç¶„ÉàÁ∑®ÈõÜÁî®„ÅÆÂ§âÊï∞
        let selectedElement = null;
        let selectedOverlay = null;
        let isDragging = false;
        let isResizing = false;
        let dragStartX = 0;
        let dragStartY = 0;
        let elementStartX = 0;
        let elementStartY = 0;
        let elementStartWidth = 0;
        let elementStartHeight = 0;
        let resizeHandle = null;
        
        // ÂàùÊúüÂåñ
        async function init() {
            await loadCurrentProject();
            await loadSlideList();
            checkServerConnection();
            setupKeyboardShortcuts();
            setupTemplateSelection();
            setupHtmlEditor();
            
            // „Ç∞„É≠„Éº„Éê„É´Èñ¢Êï∞„Å®„Åó„Å¶ÁôªÈå≤
            window.toggleEditMode = toggleEditMode;
            window.toggleLayoutMode = toggleLayoutMode;
            window.saveCurrentSlide = saveCurrentSlide;
            window.reloadCurrentSlide = reloadCurrentSlide;
            window.openPreview = openPreview;
            window.showNewSlideModal = showNewSlideModal;
            window.hideNewSlideModal = hideNewSlideModal;
            window.createNewSlide = createNewSlide;
            window.switchPreviewTab = switchPreviewTab;
            window.formatHtml = formatHtml;
        }
        
        // HTML„Ç®„Éá„Ç£„Çø„Éº„ÅÆË®≠ÂÆö
        function setupHtmlEditor() {
            const htmlEditor = document.getElementById('htmlEditor');
            
            htmlEditor.addEventListener('input', () => {
                // HTML„Ç®„Éá„Ç£„Çø„Éº„ÅßÂ§âÊõ¥„Åå„ÅÇ„Å£„ÅüÂ†¥Âêà„ÄÅËá™ÂãïÁöÑ„Å´„Éó„É¨„Éì„É•„Éº„Å´ÈÅ©Áî®
                try {
                    const previewFrame = document.getElementById('previewFrame');
                    const previewDoc = previewFrame.contentDocument;
                    previewDoc.open();
                    previewDoc.write(htmlEditor.value);
                    previewDoc.close();
                    
                    isModified = true;
                    updateUI();
                } catch (error) {
                    console.error('HTML„ÅÆËá™ÂãïÈÅ©Áî®„Ç®„É©„Éº:', error);
                }
            });
            
            htmlEditor.addEventListener('keydown', (e) => {
                // Tab„Ç≠„Éº„Åß„Ç§„É≥„Éá„É≥„Éà
                if (e.key === 'Tab') {
                    e.preventDefault();
                    const start = htmlEditor.selectionStart;
                    const end = htmlEditor.selectionEnd;
                    const value = htmlEditor.value;
                    
                    htmlEditor.value = value.substring(0, start) + '    ' + value.substring(end);
                    htmlEditor.selectionStart = htmlEditor.selectionEnd = start + 4;
                }
            });
        }
        
        // „Éó„É¨„Éì„É•„Éº„Çø„Éñ„ÅÆË°®Á§∫Âà∂Âæ°
        function updatePreviewTabsVisibility() {
            const previewTabs = document.querySelector('.preview-tabs');
            
            // „ÉÜ„Ç≠„Çπ„ÉàÁ∑®ÈõÜ„É¢„Éº„Éâ„Åæ„Åü„ÅØ„É¨„Ç§„Ç¢„Ç¶„ÉàÁ∑®ÈõÜ„É¢„Éº„Éâ„ÅÆÂ†¥Âêà„ÅØ„Çø„Éñ„ÇíÈùûË°®Á§∫
            if (editMode || layoutMode) {
                previewTabs.classList.add('hidden');
                // Âº∑Âà∂ÁöÑ„Å´„Éó„É¨„Éì„É•„Éº„Çø„Éñ„Å´Âàá„ÇäÊõø„Åà
                switchPreviewTab('preview');
            } else {
                previewTabs.classList.remove('hidden');
            }
        }
        // „Éó„É¨„Éì„É•„Éº„Çø„Éñ„ÅÆÂàá„ÇäÊõø„Åà
        function switchPreviewTab(tab) {
            const tabs = document.querySelectorAll('.preview-tab');
            const previewFrame = document.getElementById('previewFrame');
            const htmlEditorContainer = document.getElementById('htmlEditorContainer');
            
            tabs.forEach(t => t.classList.remove('active'));
            
            if (tab === 'preview') {
                tabs[0].classList.add('active');
                previewFrame.style.display = 'block';
                htmlEditorContainer.classList.remove('active');
                htmlEditorMode = false;
            } else if (tab === 'html') {
                tabs[1].classList.add('active');
                previewFrame.style.display = 'none';
                htmlEditorContainer.classList.add('active');
                htmlEditorMode = true;
                
                // ÁèæÂú®„ÅÆHTML„Çí„Ç®„Éá„Ç£„Çø„Éº„Å´Ë°®Á§∫
                if (currentSlide) {
                    const previewDoc = previewFrame.contentDocument;
                    if (previewDoc) {
                        const htmlEditor = document.getElementById('htmlEditor');
                        htmlEditor.value = previewDoc.documentElement.outerHTML;
                    }
                }
            }
        }
        
        // HTML„Éï„Ç©„Éº„Éû„ÉÉ„Éà
        function formatHtml() {
            const htmlEditor = document.getElementById('htmlEditor');
            let html = htmlEditor.value;
            
            // Á∞°Êòì„Éï„Ç©„Éº„Éû„ÉÉ„ÉàÔºàÂÆüÈöõ„ÅÆÂÆüË£Ö„Åß„ÅØÂ∞ÇÁî®„É©„Ç§„Éñ„É©„É™„Çí‰ΩøÁî®„Åô„Çã„Åì„Å®„ÇíÊé®Â•®Ôºâ
            html = html.replace(/>\s*</g, '>\n<');
            html = html.replace(/^\s*\n/gm, '');
            
            // „Ç§„É≥„Éá„É≥„Éà„ÇíËøΩÂä†
            const lines = html.split('\n');
            let indent = 0;
            const formatted = lines.map(line => {
                const trimmed = line.trim();
                if (trimmed.startsWith('</')) {
                    indent--;
                }
                const result = '    '.repeat(Math.max(0, indent)) + trimmed;
                if (trimmed.startsWith('<') && !trimmed.startsWith('</') && !trimmed.endsWith('/>')) {
                    indent++;
                }
                return result;
            });
            
            htmlEditor.value = formatted.join('\n');
            showToast('HTML„Çí„Éï„Ç©„Éº„Éû„ÉÉ„Éà„Åó„Åæ„Åó„Åü', 'success');
        }
        
        // HTMLÂ§âÊõ¥„ÇíÈÅ©Áî®ÔºàÂâäÈô§‰∫àÂÆöÔºâ
        function applyHtmlChanges() {
            // „Åì„ÅÆÈñ¢Êï∞„ÅØÂâäÈô§„Åï„Çå„Åæ„Åó„Åü - HTML„Ç®„Éá„Ç£„Çø„Éº„ÅØ„É™„Ç¢„É´„Çø„Ç§„É†„ÅßÈÅ©Áî®„Åï„Çå„Åæ„Åô
            showToast('HTML„ÅØ„É™„Ç¢„É´„Çø„Ç§„É†„ÅßÈÅ©Áî®„Åï„Çå„Å¶„ÅÑ„Åæ„Åô', 'success');
        }
        
        // „ÉÜ„É≥„Éó„É¨„Éº„ÉàÈÅ∏Êäû„ÅÆË®≠ÂÆö
        function setupTemplateSelection() {
            const templateCards = document.querySelectorAll('.template-card');
            templateCards.forEach(card => {
                card.addEventListener('click', () => {
                    templateCards.forEach(c => c.classList.remove('selected'));
                    card.classList.add('selected');
                    selectedTemplate = card.dataset.template;
                    
                    const htmlPasteArea = document.getElementById('htmlPasteArea');
                    htmlPasteArea.style.display = selectedTemplate === 'html' ? 'block' : 'none';
                });
            });
        }
        
        // Êñ∞Ë¶è„Çπ„É©„Ç§„Éâ„É¢„Éº„ÉÄ„É´„ÇíË°®Á§∫
        function showNewSlideModal() {
            document.getElementById('newSlideModal').style.display = 'block';
            document.getElementById('htmlPaste').focus();
        }
        
        // Êñ∞Ë¶è„Çπ„É©„Ç§„Éâ„É¢„Éº„ÉÄ„É´„ÇíÈùûË°®Á§∫
        function hideNewSlideModal() {
            document.getElementById('newSlideModal').style.display = 'none';
            document.getElementById('htmlPaste').value = '';
        }
        
        // Êñ∞Ë¶è„Çπ„É©„Ç§„Éâ„Çí‰ΩúÊàê
        async function createNewSlide() {
            let content = '';
            
            if (selectedTemplate === 'html') {
                content = document.getElementById('htmlPaste').value.trim();
                if (!content) {
                    showToast('HTML„Ç≥„Éº„Éâ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'error');
                    return;
                }
            } else {
                content = getTemplateContent(selectedTemplate);
            }
            
            showLoading(true);
            
            try {
                // Ê¨°„ÅÆ„Çπ„É©„Ç§„ÉâÁï™Âè∑„ÇíÂèñÂæó
                const nextNumber = await getNextSlideNumber();
                const filename = `slide-${padNumber(nextNumber)}.html`;
                
                // „Çπ„É©„Ç§„Éâ„Çí‰ΩúÊàê
                const response = await fetch(`${API_URL}/slides/create`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        filename: filename,
                        content: content 
                    })
                });
                
                if (response.ok) {
                    hideNewSlideModal();
                    await loadSlideList();
                    await loadSlide(filename);
                    showToast(`${filename} „Çí‰ΩúÊàê„Åó„Åæ„Åó„Åü`, 'success');
                } else {
                    throw new Error('„Çπ„É©„Ç§„Éâ„ÅÆ‰ΩúÊàê„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                }
            } catch (error) {
                showToast('„Çπ„É©„Ç§„Éâ„ÅÆ‰ΩúÊàê„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
                console.error('„Çπ„É©„Ç§„Éâ‰ΩúÊàê„Ç®„É©„Éº:', error);
            } finally {
                showLoading(false);
            }
        }
        
        // Ê¨°„ÅÆ„Çπ„É©„Ç§„ÉâÁï™Âè∑„ÇíÂèñÂæó
        async function getNextSlideNumber() {
            try {
                const response = await fetch(`${API_URL}/slides`);
                const data = await response.json();
                
                if (data.slides.length === 0) {
                    return 1;
                }
                
                // Êó¢Â≠ò„ÅÆ„Çπ„É©„Ç§„ÉâÁï™Âè∑„ÇíÂèñÂæó
                const numbers = data.slides.map(slide => {
                    const match = slide.match(/slide-(\d+)\.html/);
                    return match ? parseInt(match[1]) : 0;
                });
                
                return Math.max(...numbers) + 1;
            } catch (error) {
                console.error('„Çπ„É©„Ç§„ÉâÁï™Âè∑ÂèñÂæó„Ç®„É©„Éº:', error);
                return 1;
            }
        }
        
        // „ÉÜ„É≥„Éó„É¨„Éº„Éà„Ç≥„É≥„ÉÜ„É≥„ÉÑ„ÇíÂèñÂæó
        function getTemplateContent(template) {
            const templates = {
                blank: `<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Êñ∞Ë¶è„Çπ„É©„Ç§„Éâ</title>
    <style>
        .slide {
            width: 1024px;
            height: 768px;
            padding: 40px;
            font-family: 'Helvetica Neue', Arial, 'Hiragino Sans', 'Hiragino Kaku Gothic ProN', sans-serif;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            background: white;
        }
        @media print{@page{margin:0;size:landscape;} .slide{page-break-after:always;}}
    </style>
</head>
<body>
    <div class="slide">
        <h2>Êñ∞Ë¶è„Çπ„É©„Ç§„Éâ</h2>
        <p>ÂÜÖÂÆπ„ÇíÁ∑®ÈõÜ„Åó„Å¶„Åè„Å†„Åï„ÅÑ</p>
    </div>
</body>
</html>`,
                title: `<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>„Çø„Ç§„Éà„É´„Çπ„É©„Ç§„Éâ</title>
    <style>
        .slide {
            width: 1024px;
            height: 768px;
            padding: 40px;
            font-family: 'Helvetica Neue', Arial, 'Hiragino Sans', 'Hiragino Kaku Gothic ProN', sans-serif;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            background: linear-gradient(135deg, #1e3a5f 0%, #4a7ba7 100%);
            color: white;
        }
        h1 { font-size: 48px; margin-bottom: 30px; }
        h2 { font-size: 32px; margin-bottom: 20px; opacity: 0.9; }
        p { font-size: 20px; opacity: 0.8; }
        @media print{@page{margin:0;size:landscape;} .slide{page-break-after:always;}}
    </style>
</head>
<body>
    <div class="slide">
        <h1>„Éó„É¨„Çº„É≥„ÉÜ„Éº„Ç∑„Éß„É≥„Çø„Ç§„Éà„É´</h1>
        <h2>„Çµ„Éñ„Çø„Ç§„Éà„É´</h2>
        <p>Áô∫Ë°®ËÄÖÂêç„ÉªÊó•‰ªò</p>
    </div>
</body>
</html>`,
                content: `<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>„Ç≥„É≥„ÉÜ„É≥„ÉÑ„Çπ„É©„Ç§„Éâ</title>
    <style>
        .slide {
            width: 1024px;
            height: 768px;
            padding: 40px;
            font-family: 'Helvetica Neue', Arial, 'Hiragino Sans', 'Hiragino Kaku Gothic ProN', sans-serif;
            background: white;
            display: flex;
            flex-direction: column;
        }
        h2 { font-size: 32px; margin-bottom: 30px; color: #1e3a5f; }
        .content-area { flex: 1; display: flex; gap: 30px; }
        .text-area { flex: 1; }
        .visual-area { flex: 1; display: flex; align-items: center; justify-content: center; background: #f8f9fa; border-radius: 8px; }
        ul { font-size: 18px; line-height: 1.8; }
        li { margin-bottom: 10px; }
        @media print{@page{margin:0;size:landscape;} .slide{page-break-after:always;}}
    </style>
</head>
<body>
    <div class="slide">
        <h2>„Çπ„É©„Ç§„Éâ„Çø„Ç§„Éà„É´</h2>
        <div class="content-area">
            <div class="text-area">
                <ul>
                    <li>„Éù„Ç§„É≥„Éà1</li>
                    <li>„Éù„Ç§„É≥„Éà2</li>
                    <li>„Éù„Ç§„É≥„Éà3</li>
                </ul>
            </div>
            <div class="visual-area">
                <p>Âõ≥Ë°®„ÉªÁîªÂÉè„Ç®„É™„Ç¢</p>
            </div>
        </div>
    </div>
</body>
</html>`,
                summary: `<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>„Åæ„Å®„ÇÅ„Çπ„É©„Ç§„Éâ</title>
    <style>
        .slide {
            width: 1024px;
            height: 768px;
            padding: 40px;
            font-family: 'Helvetica Neue', Arial, 'Hiragino Sans', 'Hiragino Kaku Gothic ProN', sans-serif;
            background: white;
            display: flex;
            flex-direction: column;
        }
        h2 { font-size: 32px; margin-bottom: 30px; color: #1e3a5f; text-align: center; }
        .summary-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; flex: 1; }
        .summary-section { background: #f8f9fa; padding: 25px; border-radius: 8px; border-left: 4px solid #4a7ba7; }
        .summary-section h3 { font-size: 20px; margin-bottom: 15px; color: #1e3a5f; }
        .summary-section ul { font-size: 16px; line-height: 1.6; }
        .next-steps { grid-column: 1 / -1; background: #e3f2fd; border-left-color: #2196f3; }
        @media print{@page{margin:0;size:landscape;} .slide{page-break-after:always;}}
    </style>
</head>
<body>
    <div class="slide">
        <h2>„Åæ„Å®„ÇÅ</h2>
        <div class="summary-grid">
            <div class="summary-section">
                <h3>‰∏ªË¶Å„Å™„Éù„Ç§„É≥„Éà</h3>
                <ul>
                    <li>„Éù„Ç§„É≥„Éà1</li>
                    <li>„Éù„Ç§„É≥„Éà2</li>
                    <li>„Éù„Ç§„É≥„Éà3</li>
                </ul>
            </div>
            <div class="summary-section">
                <h3>Âæó„Çâ„Çå„ÅüÁü•Ë¶ã</h3>
                <ul>
                    <li>Áü•Ë¶ã1</li>
                    <li>Áü•Ë¶ã2</li>
                    <li>Áü•Ë¶ã3</li>
                </ul>
            </div>
            <div class="summary-section next-steps">
                <h3>Ê¨°„ÅÆ„Çπ„ÉÜ„ÉÉ„Éó</h3>
                <ul>
                    <li>„Ç¢„ÇØ„Ç∑„Éß„É≥1</li>
                    <li>„Ç¢„ÇØ„Ç∑„Éß„É≥2</li>
                    <li>„Ç¢„ÇØ„Ç∑„Éß„É≥3</li>
                </ul>
            </div>
        </div>
    </div>
</body>
</html>`
            };
            
            return templates[template] || templates.blank;
        }
        
        // Áï™Âè∑„Çí„Çº„É≠„Éë„Éá„Ç£„É≥„Ç∞
        function padNumber(num) {
            return String(num).padStart(2, '0');
        }
        
        // ÁèæÂú®„ÅÆ„Éó„É≠„Ç∏„Çß„ÇØ„ÉàÊÉÖÂ†±„ÇíÂèñÂæó
        async function loadCurrentProject() {
            try {
                const response = await fetch(`${API_URL}/current-project`);
                if (response.ok) {
                    const data = await response.json();
                    currentProjectName = data.projectPath;
                }
            } catch (error) {
                console.error('„Éó„É≠„Ç∏„Çß„ÇØ„ÉàÊÉÖÂ†±„ÅÆÂèñÂæó„Ç®„É©„Éº:', error);
            }
        }
        
        // ÂÖ®‰Ωì„Éó„É¨„Éì„É•„Éº„ÇíÈñã„Åè
        function openPreview() {
            if (!currentProjectName) {
                showToast('„Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÅåÈÅ∏Êäû„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì', 'error');
                return;
            }
            
            const previewUrl = `/preview/slide_all_display.html?project=${encodeURIComponent(currentProjectName)}`;
            window.open(previewUrl, '_blank');
            showToast('„Éó„É¨„Éì„É•„Éº„ÇíÊñ∞„Åó„ÅÑ„Çø„Éñ„ÅßÈñã„Åç„Åæ„Åó„Åü', 'success');
        }
        
        // „Ç≠„Éº„Éú„Éº„Éâ„Ç∑„Éß„Éº„Éà„Ç´„ÉÉ„Éà„ÅÆË®≠ÂÆö
        function setupKeyboardShortcuts() {
            document.addEventListener('keydown', (e) => {
                // Ctrl+S „Åß‰øùÂ≠òÔºà„Éá„Éï„Ç©„É´„Éà„ÅÆWeb„Éö„Éº„Ç∏‰øùÂ≠ò„ÇíÈò≤„ÅêÔºâ
                if (e.ctrlKey && e.key === 's') {
                    e.preventDefault();
                    e.stopPropagation();
                    if (!document.getElementById('saveBtn').disabled) {
                        saveCurrentSlide();
                    }
                    return false;
                }
                
                // Ctrl+P „Åß„Éó„É¨„Éì„É•„ÉºÔºà„Éá„Éï„Ç©„É´„Éà„ÅÆÂç∞Âà∑„ÇíÈò≤„ÅêÔºâ
                if (e.ctrlKey && e.key === 'p') {
                    e.preventDefault();
                    e.stopPropagation();
                    openPreview();
                    return false;
                }
            }, true); // „Ç≠„É£„Éó„ÉÅ„É£„Éï„Çß„Éº„Ç∫„ÅßÂá¶ÁêÜ
        }
        
        // „Çµ„Éº„Éê„ÉºÊé•Á∂ö„ÉÅ„Çß„ÉÉ„ÇØ
        async function checkServerConnection() {
            try {
                const response = await fetch(`${API_URL}/slides`);
                if (response.ok) {
                    document.getElementById('serverStatus').textContent = '„Çµ„Éº„Éê„Éº: Êé•Á∂öÊ∏à„Åø ‚úì';
                }
            } catch (error) {
                document.getElementById('serverStatus').textContent = '„Çµ„Éº„Éê„Éº: Êú™Êé•Á∂ö ‚úó';
                showToast('„Çµ„Éº„Éê„Éº„Å´Êé•Á∂ö„Åß„Åç„Åæ„Åõ„Çì„ÄÇNode.js„Çµ„Éº„Éê„Éº„ÇíËµ∑Âãï„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ', 'error');
            }
        }
        
        // „Çπ„É©„Ç§„Éâ‰∏ÄË¶ß„ÇíË™≠„ÅøËæº„Åø
        async function loadSlideList() {
            try {
                const response = await fetch(`${API_URL}/slides`);
                const data = await response.json();
                
                const slideList = document.getElementById('slideList');
                slideList.innerHTML = '';
                
                data.slides.forEach(slide => {
                    const li = document.createElement('li');
                    li.className = 'slide-item';
                    li.innerHTML = `
                        <span onclick="loadSlide('${slide}')">${slide}</span>
                        <div class="slide-actions">
                            <button class="slide-action-btn" onclick="deleteSlide('${slide}')" title="ÂâäÈô§">üóëÔ∏è</button>
                        </div>
                    `;
                    slideList.appendChild(li);
                });
            } catch (error) {
                console.error('„Çπ„É©„Ç§„Éâ‰∏ÄË¶ß„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó:', error);
            }
        }
        
        // „Çπ„É©„Ç§„Éâ„ÇíÂâäÈô§
        async function deleteSlide(filename) {
            if (!confirm(`${filename} „ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü„Åì„ÅÆÊìç‰Ωú„ÅØÂÖÉ„Å´Êàª„Åõ„Åæ„Åõ„Çì„ÄÇ`)) {
                return;
            }
            
            try {
                const response = await fetch(`${API_URL}/slides/${filename}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    if (currentSlide === filename) {
                        currentSlide = null;
                        originalContent = null;
                        isModified = false;
                        document.getElementById('previewFrame').src = '';
                        updateUI();
                    }
                    
                    await loadSlideList();
                    showToast(`${filename} „ÇíÂâäÈô§„Åó„Åæ„Åó„Åü`, 'success');
                } else {
                    throw new Error('ÂâäÈô§„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                }
            } catch (error) {
                showToast('„Çπ„É©„Ç§„Éâ„ÅÆÂâäÈô§„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
            }
        }
        
        // „Çπ„É©„Ç§„Éâ„ÇíË™≠„ÅøËæº„Åø
        async function loadSlide(filename) {
            showLoading(true);
            
            try {
                const response = await fetch(`${API_URL}/slides/${filename}`);
                const data = await response.json();
                
                currentSlide = filename;
                originalContent = data.content;
                isModified = false;
                
                // „Éó„É¨„Éì„É•„Éº„ÇíÊõ¥Êñ∞
                const previewDoc = document.getElementById('previewFrame').contentDocument;
                previewDoc.open();
                previewDoc.write(data.content);
                previewDoc.close();
                
                // HTML„Ç®„Éá„Ç£„Çø„Éº„ÇíÊõ¥Êñ∞
                const htmlEditor = document.getElementById('htmlEditor');
                htmlEditor.value = data.content;
                
                // UIÊõ¥Êñ∞
                updateUI();
                
                // „Éó„É¨„Éì„É•„Éº„Çø„Éñ„ÅÆË°®Á§∫Âà∂Âæ°
                updatePreviewTabsVisibility();
                
                // „Ç¢„ÇØ„ÉÜ„Ç£„ÉñË°®Á§∫
                document.querySelectorAll('.slide-item').forEach(item => {
                    item.classList.toggle('active', item.querySelector('span').textContent === filename);
                });
                
                // Á∑®ÈõÜ„É¢„Éº„Éâ„ÅÆÂ†¥Âêà„ÅØ„ÉÜ„Ç≠„Çπ„Éà„ÇíÊäΩÂá∫
                if (editMode) {
                    await extractTextElements();
                }
                
                showToast(`${filename} „ÇíË™≠„ÅøËæº„Åø„Åæ„Åó„Åü`);
            } catch (error) {
                showToast('„Çπ„É©„Ç§„Éâ„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
            } finally {
                showLoading(false);
            }
        }
        
        // ÁèæÂú®„ÅÆ„Çπ„É©„Ç§„Éâ„Çí‰øùÂ≠ò
        async function saveCurrentSlide() {
            if (!currentSlide || !isModified) return;
            
            showLoading(true);
            
            try {
                let content;
                if (htmlEditorMode) {
                    content = document.getElementById('htmlEditor').value;
                } else {
                    const previewDoc = document.getElementById('previewFrame').contentDocument;
                    content = previewDoc.documentElement.outerHTML;
                }
                
                const response = await fetch(`${API_URL}/slides/${currentSlide}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ content })
                });
                
                if (response.ok) {
                    originalContent = content;
                    isModified = false;
                    updateUI();
                    showToast('‰øùÂ≠ò„Åó„Åæ„Åó„Åü', 'success');
                } else {
                    throw new Error('‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                }
            } catch (error) {
                showToast('‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
            } finally {
                showLoading(false);
            }
        }
        
        // Á∑®ÈõÜ„É¢„Éº„ÉâÂàá„ÇäÊõø„Åà
        async function toggleEditMode() {
            editMode = !editMode;
            const editPanel = document.getElementById('editPanel');
            const editBtn = document.getElementById('editModeBtn');
            
            editPanel.classList.toggle('show', editMode);
            editBtn.classList.toggle('active', editMode);
            editBtn.textContent = editMode ? 'üìù Á∑®ÈõÜ„É¢„Éº„ÉâÁµÇ‰∫Ü' : '‚úèÔ∏è Á∞°ÊòìÁ∑®ÈõÜ„É¢„Éº„Éâ';
            
            // „Éó„É¨„Éì„É•„Éº„Çø„Éñ„ÅÆË°®Á§∫Âà∂Âæ°
            updatePreviewTabsVisibility();
            
            if (editMode && currentSlide) {
                await extractTextElements();
            }
        }
        
        // „ÉÜ„Ç≠„Çπ„ÉàË¶ÅÁ¥†„ÇíÊäΩÂá∫„Åó„Å¶Á∑®ÈõÜ„Éë„Éç„É´„Å´Ë°®Á§∫
        async function extractTextElements() {
            const previewDoc = document.getElementById('previewFrame').contentDocument;
            const editPanelContent = document.getElementById('editPanelContent');
            editPanelContent.innerHTML = '';
            
            const textElements = [];
            const processedElements = new Set();
            
            function collectTextElements(node) {
                if (node.nodeType === Node.TEXT_NODE) {
                    const text = node.textContent.trim();
                    if (text && node.parentElement && !processedElements.has(node.parentElement)) {
                        const parent = node.parentElement;
                        
                        if (!['SCRIPT', 'STYLE', 'NOSCRIPT'].includes(parent.tagName)) {
                            processedElements.add(parent);
                            
                            const hasOnlyTextNodes = Array.from(parent.childNodes).every(
                                child => child.nodeType === Node.TEXT_NODE || 
                                        (child.nodeType === Node.ELEMENT_NODE && child.children.length === 0)
                            );
                            
                            if (hasOnlyTextNodes) {
                                textElements.push({
                                    element: parent,
                                    text: parent.textContent.trim(),
                                    tagName: parent.tagName,
                                    className: parent.className
                                });
                            }
                        }
                    }
                } else if (node.nodeType === Node.ELEMENT_NODE) {
                    for (const child of node.childNodes) {
                        collectTextElements(child);
                    }
                }
            }
            
            const body = previewDoc.body;
            if (body) {
                collectTextElements(body);
            }
            
            const uniqueElements = textElements.filter((item, index, self) => 
                item.text && 
                self.findIndex(t => t.element === item.element) === index
            );
            
            uniqueElements.forEach((item, index) => {
                const field = document.createElement('div');
                field.className = 'edit-field';
                
                const label = document.createElement('label');
                const displayTag = item.className ? `${item.tagName}.${item.className.split(' ')[0]}` : item.tagName;
                label.textContent = `${displayTag} - ${item.text.substring(0, 40)}${item.text.length > 40 ? '...' : ''}`;
                label.title = item.text;
                
                const textarea = document.createElement('textarea');
                textarea.value = item.text;
                textarea.dataset.elementIndex = index;
                
                const lineCount = Math.max(2, Math.ceil(item.text.length / 40));
                textarea.style.minHeight = `${lineCount * 25}px`;
                
                textarea.oninput = function() {
                    item.element.textContent = this.value;
                    isModified = true;
                    updateUI();
                };
                
                field.appendChild(label);
                field.appendChild(textarea);
                editPanelContent.appendChild(field);
            });
            
            if (uniqueElements.length === 0) {
                editPanelContent.innerHTML = '<p style="color: #666;">Á∑®ÈõÜÂèØËÉΩ„Å™„ÉÜ„Ç≠„Çπ„Éà„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì</p>';
            } else {
                const countInfo = document.createElement('div');
                countInfo.style.cssText = 'padding: 10px; background: #f0f0f0; margin-bottom: 15px; border-radius: 4px;';
                countInfo.textContent = `${uniqueElements.length}ÂÄã„ÅÆ„ÉÜ„Ç≠„Çπ„ÉàË¶ÅÁ¥†„ÅåÁ∑®ÈõÜÂèØËÉΩ„Åß„Åô`;
                editPanelContent.insertBefore(countInfo, editPanelContent.firstChild);
            }
        }
        
        // ÁèæÂú®„ÅÆ„Çπ„É©„Ç§„Éâ„ÇíÂÜçË™≠„ÅøËæº„Åø
        function reloadCurrentSlide() {
            if (currentSlide) {
                if (isModified) {
                    if (confirm('Â§âÊõ¥„Åå‰øùÂ≠ò„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇÂÜçË™≠„ÅøËæº„Åø„Åó„Åæ„Åô„ÅãÔºü')) {
                        loadSlide(currentSlide);
                    }
                } else {
                    loadSlide(currentSlide);
                }
            }
        }
        
        // UIÊõ¥Êñ∞
        function updateUI() {
            const saveBtn = document.getElementById('saveBtn');
            const currentInfo = document.getElementById('currentSlideInfo');
            
            saveBtn.disabled = !isModified;
            
            if (currentSlide) {
                currentInfo.textContent = currentSlide + (isModified ? ' (Â§âÊõ¥„ÅÇ„Çä)' : '');
            } else {
                currentInfo.textContent = '„Çπ„É©„Ç§„Éâ„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ';
            }
            
            document.querySelectorAll('.slide-item').forEach(item => {
                const span = item.querySelector('span');
                if (span && span.textContent === currentSlide) {
                    item.classList.toggle('modified', isModified);
                }
            });
        }
        
        // „É¨„Ç§„Ç¢„Ç¶„ÉàÁ∑®ÈõÜ„É¢„Éº„ÉâÂàá„ÇäÊõø„Åà
        function toggleLayoutMode() {
            if (!currentSlide) {
                showToast('ÂÖà„Å´„Çπ„É©„Ç§„Éâ„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'error');
                return;
            }
            
            layoutMode = !layoutMode;
            const layoutBtn = document.getElementById('layoutModeBtn');
            const previewContainer = document.getElementById('previewContainer');
            
            if (layoutMode) {
                if (editMode) {
                    toggleEditMode();
                }
                
                layoutBtn.classList.add('active');
                layoutBtn.textContent = 'üé® „É¨„Ç§„Ç¢„Ç¶„ÉàÁ∑®ÈõÜÁµÇ‰∫Ü';
                previewContainer.classList.add('show-grid');
                document.body.classList.add('layout-mode');
                
                setupLayoutListeners();
                showToast('Ë¶ÅÁ¥†„Çí„ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶ÈÅ∏Êäû„ÄÅ„Éâ„É©„ÉÉ„Ç∞„ÅßÁßªÂãï„ÄÅÁü¢Âç∞„Ç≠„Éº„ÅßÂæÆË™øÊï¥', 'success', 3000);
            } else {
                layoutBtn.classList.remove('active');
                layoutBtn.textContent = 'üé® „É¨„Ç§„Ç¢„Ç¶„ÉàÁ∑®ÈõÜ';
                previewContainer.classList.remove('show-grid');
                document.body.classList.remove('layout-mode');
                
                removeLayoutListeners();
            }
            
            // „Éó„É¨„Éì„É•„Éº„Çø„Éñ„ÅÆË°®Á§∫Âà∂Âæ°
            updatePreviewTabsVisibility();
        }
        
        // „É¨„Ç§„Ç¢„Ç¶„ÉàÁ∑®ÈõÜ„ÅÆ„Ç§„Éô„É≥„Éà„É™„Çπ„Éä„ÉºË®≠ÂÆö
        function setupLayoutListeners() {
            const previewFrame = document.getElementById('previewFrame');
            const layoutOverlay = document.getElementById('layoutOverlay');
            
            try {
                const previewDoc = previewFrame.contentDocument || previewFrame.contentWindow.document;
                
                if (!previewDoc) {
                    showToast('„Éó„É¨„Éì„É•„Éº„Éï„É¨„Éº„É†„Å´„Ç¢„ÇØ„Çª„Çπ„Åß„Åç„Åæ„Åõ„Çì„ÄÇ', 'error');
                    return;
                }
                
                layoutOverlay.innerHTML = '';
                
                const selectableSelectors = [
                    '.slide > *',
                    'div:not(.slide)',
                    'section', 'table', 'ul', 'ol', 'img', 
                    'p', 'h1', 'h2', 'h3', 'h4', 'h5', 'h6',
                    '.content-area > *',
                    '.main-content > *',
                    '.table-section', '.info-section',
                    '.result-box', '.explanation-box'
                ];
                
                const selectableElements = previewDoc.querySelectorAll(selectableSelectors.join(', '));
                
                selectableElements.forEach((elem, index) => {
                    createElementOverlay(elem, index, previewFrame, layoutOverlay);
                });
                
                previewDoc.addEventListener('scroll', () => updateOverlayPositions(previewFrame, layoutOverlay));
                previewFrame.contentWindow.addEventListener('resize', () => updateOverlayPositions(previewFrame, layoutOverlay));
                
                layoutOverlay.addEventListener('mousedown', handleOverlayMouseDown);
                document.addEventListener('mousemove', handleMouseMove);
                document.addEventListener('mouseup', handleMouseUp);
                document.addEventListener('keydown', handleKeyDown);
                
            } catch (error) {
                console.error('„É¨„Ç§„Ç¢„Ç¶„Éà„É™„Çπ„Éä„Éº„ÅÆË®≠ÂÆö„Ç®„É©„Éº:', error);
                showToast('„É¨„Ç§„Ç¢„Ç¶„ÉàÁ∑®ÈõÜÊ©üËÉΩ„ÅÆÂàùÊúüÂåñ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
            }
        }

        function createElementOverlay(elem, index, previewFrame, layoutOverlay) {
            const coords = getElementCoordinates(elem, previewFrame);
            
            if (coords.width > 0 && coords.height > 0) {
                const overlay = document.createElement('div');
                overlay.className = 'element-overlay';
                overlay.dataset.elementIndex = index;
                
                overlay.style.left = `${coords.left}px`;
                overlay.style.top = `${coords.top}px`;
                overlay.style.width = `${coords.width}px`;
                overlay.style.height = `${coords.height}px`;
                
                const handles = ['nw', 'ne', 'sw', 'se'];
                handles.forEach(handle => {
                    const handleDiv = document.createElement('div');
                    handleDiv.className = `resize-handle ${handle}`;
                    overlay.appendChild(handleDiv);
                });
                
                const posInfo = document.createElement('div');
                posInfo.className = 'position-info';
                posInfo.textContent = 'X: 0, Y: 0';
                overlay.appendChild(posInfo);
                
                overlay.addEventListener('click', function(e) {
                    e.stopPropagation();
                    selectElementOverlay(this, elem);
                });
                
                const previewDoc = previewFrame.contentDocument;
                const style = previewDoc.defaultView.getComputedStyle(elem);
                if (style.position === 'static') {
                    elem.style.position = 'relative';
                }
                
                overlay._targetElement = elem;
                
                layoutOverlay.appendChild(overlay);
            }
        }
        
        function selectElementOverlay(overlay, targetElement){
            document.querySelectorAll('.element-overlay.selected')
                    .forEach(el => el.classList.remove('selected'));

            overlay.classList.add('selected');
            selectedOverlay  = overlay;
            selectedElement  = targetElement;

            updatePositionInfo();
        }
        
        function updateOverlayPositions(previewFrame, layoutOverlay) {
            if (!layoutOverlay) layoutOverlay = document.getElementById('layoutOverlay');
            if (!previewFrame) previewFrame = document.getElementById('previewFrame');
            
            const overlays = layoutOverlay.querySelectorAll('.element-overlay');
            
            overlays.forEach(overlay => {
                const elem = overlay._targetElement;
                if (elem) {
                    const coords = getElementCoordinates(elem, previewFrame);
                    overlay.style.left = `${coords.left}px`;
                    overlay.style.top = `${coords.top}px`;
                    overlay.style.width = `${coords.width}px`;
                    overlay.style.height = `${coords.height}px`;
                }
            });
        }

        function getElementCoordinates(elem, previewFrame) {
            const previewDoc = previewFrame.contentDocument;
            const frameRect = previewFrame.getBoundingClientRect();
            const elemRect = elem.getBoundingClientRect();
            
            const scrollTop = previewDoc.documentElement.scrollTop || previewDoc.body.scrollTop || 0;
            const scrollLeft = previewDoc.documentElement.scrollLeft || previewDoc.body.scrollLeft || 0;
            
            const previewHeader = document.querySelector('.preview-header');
            const headerHeight = previewHeader ? previewHeader.offsetHeight : 0;
            
            const left = elemRect.left;
            const top = elemRect.top + headerHeight;
            
            return {
                left: left,
                top: top,
                width: elemRect.width,
                height: elemRect.height
            };
        }
        
        function handleOverlayMouseDown(e) {
            const target = e.target;
            
            if (target.classList.contains('resize-handle')) {
                isResizing = true;
                resizeHandle = target;
                dragStartX = e.clientX;
                dragStartY = e.clientY;
                
                const overlay = target.closest('.element-overlay');
                if (overlay && overlay._targetElement) {
                    selectedElement = overlay._targetElement;
                    selectedOverlay = overlay;
                    elementStartWidth = selectedElement.offsetWidth;
                    elementStartHeight = selectedElement.offsetHeight;
                    elementStartX = parseInt(selectedElement.style.left) || 0;
                    elementStartY = parseInt(selectedElement.style.top) || 0;
                }
                e.preventDefault();
            } else if (target.classList.contains('element-overlay')) {
                isDragging = true;
                dragStartX = e.clientX;
                dragStartY = e.clientY;
                
                selectedElement = target._targetElement;
                selectedOverlay = target;
                elementStartX = parseInt(selectedElement.style.left) || 0;
                elementStartY = parseInt(selectedElement.style.top) || 0;
                
                target.classList.add('dragging');
                e.preventDefault();
            }
        }
        
        function removeLayoutListeners() {
            const previewFrame = document.getElementById('previewFrame');
            const layoutOverlay = document.getElementById('layoutOverlay');
            
            try {
                const previewDoc = previewFrame.contentDocument || previewFrame.contentWindow.document;
                
                if (previewDoc) {
                    previewDoc.removeEventListener('scroll', updateOverlayPositions);
                    previewFrame.contentWindow.removeEventListener('resize', updateOverlayPositions);
                }
                
                layoutOverlay.innerHTML = '';
                
                layoutOverlay.removeEventListener('mousedown', handleOverlayMouseDown);
                document.removeEventListener('mousemove', handleMouseMove);
                document.removeEventListener('mouseup', handleMouseUp);
                document.removeEventListener('keydown', handleKeyDown);
                
            } catch (error) {
                console.error('„É¨„Ç§„Ç¢„Ç¶„Éà„É™„Çπ„Éä„Éº„ÅÆÂâäÈô§„Ç®„É©„Éº:', error);
            }
        }
        
        function updatePositionInfo() {
            if (!selectedElement || !selectedOverlay) return;
            
            const info = selectedOverlay.querySelector('.position-info');
            const style = selectedElement.style;
            const left = parseInt(style.left) || 0;
            const top = parseInt(style.top) || 0;
            const width = selectedElement.offsetWidth;
            const height = selectedElement.offsetHeight;
            
            info.textContent = `X: ${left}, Y: ${top} | W: ${width}, H: ${height}`;
        }
        
        function handleMouseMove(e) {
            if (!layoutMode || !selectedElement) return;
            
            if (isDragging) {
                const deltaX = e.clientX - dragStartX;
                const deltaY = e.clientY - dragStartY;
                
                selectedElement.style.left = `${elementStartX + deltaX}px`;
                selectedElement.style.top = `${elementStartY + deltaY}px`;
                
                updateOverlayPositions();
                updatePositionInfo();
                isModified = true;
                updateUI();
            } else if (isResizing) {
                const deltaX = e.clientX - dragStartX;
                const deltaY = e.clientY - dragStartY;
                
                if (resizeHandle.classList.contains('se')) {
                    selectedElement.style.width = `${elementStartWidth + deltaX}px`;
                    selectedElement.style.height = `${elementStartHeight + deltaY}px`;
                } else if (resizeHandle.classList.contains('sw')) {
                    selectedElement.style.width = `${elementStartWidth - deltaX}px`;
                    selectedElement.style.height = `${elementStartHeight + deltaY}px`;
                    selectedElement.style.left = `${elementStartX + deltaX}px`;
                } else if (resizeHandle.classList.contains('ne')) {
                    selectedElement.style.width = `${elementStartWidth + deltaX}px`;
                    selectedElement.style.height = `${elementStartHeight - deltaY}px`;
                    selectedElement.style.top = `${elementStartY + deltaY}px`;
                } else if (resizeHandle.classList.contains('nw')) {
                    selectedElement.style.width = `${elementStartWidth - deltaX}px`;
                    selectedElement.style.height = `${elementStartHeight - deltaY}px`;
                    selectedElement.style.left = `${elementStartX + deltaX}px`;
                    selectedElement.style.top = `${elementStartY + deltaY}px`;
                }
                
                updateOverlayPositions();
                updatePositionInfo();
                isModified = true;
                updateUI();
            }
        }
        
        function handleMouseUp(e) {
            if (isDragging && selectedOverlay) {
                selectedOverlay.classList.remove('dragging');
            }
            
            isDragging = false;
            isResizing = false;
            resizeHandle = null;
        }
        
        function handleKeyDown(e) {
            if (!layoutMode || !selectedElement) return;
            
            const step = e.shiftKey ? 10 : 1;
            let left = parseInt(selectedElement.style.left) || 0;
            let top = parseInt(selectedElement.style.top) || 0;
            let modified = false;
            
            switch(e.key) {
                case 'ArrowLeft':
                    selectedElement.style.left = `${left - step}px`;
                    modified = true;
                    break;
                case 'ArrowRight':
                    selectedElement.style.left = `${left + step}px`;
                    modified = true;
                    break;
                case 'ArrowUp':
                    selectedElement.style.top = `${top - step}px`;
                    modified = true;
                    break;
                case 'ArrowDown':
                    selectedElement.style.top = `${top + step}px`;
                    modified = true;
                    break;
                case 'Delete':
                case 'Backspace':
                    selectedElement.style.left = '';
                    selectedElement.style.top = '';
                    selectedElement.style.width = '';
                    selectedElement.style.height = '';
                    modified = true;
                    break;
            }
            
            if (modified) {
                e.preventDefault();
                updateOverlayPositions();
                updatePositionInfo();
                isModified = true;
                updateUI();
            }
        }
        
        function showLoading(show) {
            document.getElementById('loading').classList.toggle('show', show);
        }
        
        function showToast(message, type = 'success', duration = 3000) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast show ${type}`;
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, duration);
        }
        
        // „É¢„Éº„ÉÄ„É´Â§ñ„ÇØ„É™„ÉÉ„ÇØ„ÅßÈñâ„Åò„Çã
        document.addEventListener('click', (e) => {
            if (e.target.id === 'newSlideModal') {
                hideNewSlideModal();
            }
        });
        
        // ÂàùÊúüÂåñÂÆüË°å
        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>